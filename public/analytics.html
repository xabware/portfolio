<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio Analytics</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root {
      --bg: #0a0a0f;
      --surface: #12121a;
      --surface2: #1a1a2e;
      --border: #2a2a3e;
      --text: #e0e0e0;
      --text2: #8888aa;
      --accent: #6c63ff;
      --accent2: #4ecdc4;
      --green: #4ecdc4;
      --red: #ff6b6b;
      --orange: #ffa726;
      --blue: #42a5f5;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* Login */
    .login-overlay {
      position: fixed; inset: 0;
      background: var(--bg);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 40px;
      text-align: center;
      max-width: 360px;
      width: 90%;
    }
    .login-box h2 { margin-bottom: 8px; color: var(--accent); }
    .login-box p { color: var(--text2); margin-bottom: 24px; font-size: 14px; }
    .login-box input {
      width: 100%; padding: 12px 16px;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 16px;
      text-align: center; letter-spacing: 4px;
      outline: none;
    }
    .login-box input:focus { border-color: var(--accent); }
    .login-box button {
      width: 100%; margin-top: 16px; padding: 12px;
      background: var(--accent); color: white; border: none;
      border-radius: 8px; font-size: 16px; cursor: pointer;
    }
    .login-box button:hover { opacity: 0.9; }
    .login-error { color: var(--red); font-size: 13px; margin-top: 12px; }

    /* Dashboard */
    .dashboard { display: none; padding: 24px; max-width: 1400px; margin: 0 auto; }
    .dashboard.visible { display: block; }

    .dashboard-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
    }
    .dashboard-header h1 { font-size: 24px; color: var(--accent); }
    .header-controls { display: flex; gap: 12px; align-items: center; }
    .header-controls select, .header-controls button {
      padding: 8px 16px; background: var(--surface);
      border: 1px solid var(--border); border-radius: 8px;
      color: var(--text); font-size: 14px; cursor: pointer;
    }
    .header-controls button:hover { border-color: var(--accent); }
    .btn-refresh { background: var(--accent) !important; border: none !important; }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px; margin-bottom: 32px;
    }
    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-card .label { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
    .stat-card .value { font-size: 32px; font-weight: 700; margin-top: 4px; }
    .stat-card .sub { font-size: 13px; color: var(--text2); margin-top: 4px; }
    .stat-card.accent .value { color: var(--accent); }
    .stat-card.green .value { color: var(--green); }
    .stat-card.blue .value { color: var(--blue); }
    .stat-card.orange .value { color: var(--orange); }

    /* Charts area */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px; margin-bottom: 32px;
    }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .chart-card h3 { font-size: 16px; margin-bottom: 16px; color: var(--text2); }

    /* Bar chart */
    .bar-chart { display: flex; flex-direction: column; gap: 8px; }
    .bar-row { display: flex; align-items: center; gap: 12px; }
    .bar-label { width: 120px; font-size: 13px; color: var(--text2); text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .bar-track { flex: 1; height: 24px; background: var(--surface2); border-radius: 4px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; display: flex; align-items: center; padding-left: 8px; font-size: 12px; color: white; min-width: fit-content; }
    .bar-value { font-size: 13px; color: var(--text); width: 40px; text-align: right; }

    /* Table */
    .table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      overflow-x: auto;
    }
    .table-card h3 { font-size: 16px; margin-bottom: 16px; color: var(--text2); }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 10px 12px; font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
    td { padding: 10px 12px; font-size: 13px; border-bottom: 1px solid var(--border); }
    tr:hover td { background: var(--surface2); }
    .badge {
      display: inline-block; padding: 2px 8px; border-radius: 4px;
      font-size: 11px; font-weight: 600;
    }
    .badge-mobile { background: #ff6b6b22; color: var(--red); }
    .badge-desktop { background: #42a5f522; color: var(--blue); }
    .badge-tablet { background: #ffa72622; color: var(--orange); }

    .flag { margin-right: 6px; }

    /* Map placeholder */
    .map-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .country-chip {
      display: flex; align-items: center; gap: 6px;
      background: var(--surface2); padding: 6px 12px;
      border-radius: 8px; font-size: 13px;
    }
    .country-chip .count { color: var(--accent); font-weight: 600; }

    /* Loading */
    .loading-spinner {
      display: flex; align-items: center; justify-content: center;
      padding: 60px; color: var(--text2);
    }
    .spinner {
      width: 32px; height: 32px; border: 3px solid var(--border);
      border-top-color: var(--accent); border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-right: 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Timeline */
    .timeline-bars { display: flex; align-items: flex-end; gap: 2px; height: 120px; }
    .timeline-bar {
      flex: 1; background: var(--accent); border-radius: 2px 2px 0 0;
      min-width: 4px; position: relative; cursor: pointer;
      transition: opacity 0.2s;
    }
    .timeline-bar:hover { opacity: 0.8; }
    .timeline-bar .tooltip {
      display: none; position: absolute; bottom: 100%; left: 50%;
      transform: translateX(-50%); background: var(--surface2);
      border: 1px solid var(--border); border-radius: 6px;
      padding: 4px 8px; font-size: 11px; white-space: nowrap;
      z-index: 10;
    }
    .timeline-bar:hover .tooltip { display: block; }
    .timeline-labels { display: flex; justify-content: space-between; margin-top: 8px; font-size: 11px; color: var(--text2); }

    @media (max-width: 768px) {
      .charts-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .bar-label { width: 80px; }
    }
  </style>
</head>
<body>

  <!-- Login -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-box">
      <h2>Analytics</h2>
      <p>Introduce el PIN para acceder al dashboard</p>
      <input type="password" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="20" autocomplete="off">
      <button onclick="checkPin()">Acceder</button>
      <div class="login-error" id="loginError"></div>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <div class="dashboard-header">
      <h1>üìä Portfolio Analytics</h1>
      <div class="header-controls">
        <select id="timeFilter">
          <option value="today">Hoy</option>
          <option value="7d" selected>√öltimos 7 d√≠as</option>
          <option value="30d">√öltimos 30 d√≠as</option>
          <option value="all">Todo</option>
        </select>
        <button class="btn-refresh" onclick="loadAllData()">‚Üª Actualizar</button>
      </div>
    </div>

    <div class="loading-spinner" id="loading">
      <div class="spinner"></div>
      Cargando datos...
    </div>

    <div id="content" style="display:none;">
      <!-- Stats -->
      <div class="stats-grid" id="statsGrid"></div>

      <!-- Charts -->
      <div class="charts-grid">
        <div class="chart-card">
          <h3>üìÖ Visitas por d√≠a</h3>
          <div id="timelineChart"></div>
        </div>
        <div class="chart-card">
          <h3>üåç Pa√≠ses</h3>
          <div id="countriesChart"></div>
        </div>
        <div class="chart-card">
          <h3>üñ•Ô∏è Navegadores</h3>
          <div id="browsersChart"></div>
        </div>
        <div class="chart-card">
          <h3>üì± Dispositivos</h3>
          <div id="devicesChart"></div>
        </div>
        <div class="chart-card">
          <h3>üìÑ P√°ginas m√°s visitadas</h3>
          <div id="pagesChart"></div>
        </div>
        <div class="chart-card">
          <h3>üîó Referrers</h3>
          <div id="referrersChart"></div>
        </div>
      </div>

      <!-- Recent visitors table -->
      <div class="table-card">
        <h3>üë• √öltimos visitantes</h3>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Pa√≠s / Ciudad</th>
              <th>Dispositivo</th>
              <th>Navegador</th>
              <th>Pantalla</th>
              <th>Idioma</th>
              <th>Referrer</th>
            </tr>
          </thead>
          <tbody id="visitorsTable"></tbody>
        </table>
      </div>

      <!-- Events table -->
      <div class="table-card">
        <h3>‚ö° √öltimos eventos</h3>
        <table>
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Evento</th>
              <th>Datos</th>
            </tr>
          </thead>
          <tbody id="eventsTable"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, query, orderBy, limit, where, Timestamp } from 'https://www.gstatic.com/firebasejs/11.7.1/firebase-firestore.js';

    // Config ‚Äî mismos valores que tu app
    const firebaseConfig = {
      apiKey: "AIzaSyCwF2Rn_a4d8fyQd8rteG1Cf3U99OrtSzI",
      authDomain: "portfolio-fac26.firebaseapp.com",
      projectId: "portfolio-fac26",
      storageBucket: "portfolio-fac26.firebasestorage.app",
      messagingSenderId: "737494374243",
      appId: "1:737494374243:web:7638fc2da720e5f3e86556",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- PIN Protection ---
    // Cambia este PIN por el que quieras
    const DASHBOARD_PIN = 'admin1234';

    window.checkPin = function() {
      const input = document.getElementById('pinInput').value;
      if (input === DASHBOARD_PIN) {
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('dashboard').classList.add('visible');
        loadAllData();
      } else {
        document.getElementById('loginError').textContent = 'PIN incorrecto';
      }
    };

    document.getElementById('pinInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') window.checkPin();
    });

    // --- Time filter ---
    function getTimeFilter() {
      const filter = document.getElementById('timeFilter').value;
      const now = new Date();
      switch (filter) {
        case 'today':
          const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
          return Timestamp.fromDate(today);
        case '7d':
          return Timestamp.fromDate(new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000));
        case '30d':
          return Timestamp.fromDate(new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000));
        case 'all':
          return null;
      }
    }

    document.getElementById('timeFilter').addEventListener('change', () => loadAllData());

    // --- Data loading ---
    async function fetchCollection(name, limitCount = 5000) {
      const timeFilter = getTimeFilter();
      let q;
      if (timeFilter) {
        q = query(collection(db, name), where('timestamp', '>=', timeFilter), orderBy('timestamp', 'desc'), limit(limitCount));
      } else {
        q = query(collection(db, name), orderBy('timestamp', 'desc'), limit(limitCount));
      }
      const snapshot = await getDocs(q);
      return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    window.loadAllData = async function() {
      document.getElementById('loading').style.display = 'flex';
      document.getElementById('content').style.display = 'none';

      try {
        const [visitors, pageviews, events, uniqueVisitors] = await Promise.all([
          fetchCollection('visitors'),
          fetchCollection('pageviews'),
          fetchCollection('events'),
          getDocs(collection(db, 'unique_visitors')).then(s => s.docs.map(d => ({ id: d.id, ...d.data() }))),
        ]);

        renderStats(visitors, pageviews, events, uniqueVisitors);
        renderTimeline(visitors);
        renderBarChart('countriesChart', countBy(visitors, v => v.geo ? `${countryFlag(v.geo.countryCode)} ${v.geo.country}` : 'üåê Desconocido'), var_accent());
        renderBarChart('browsersChart', countBy(visitors, v => v.browser || 'Desconocido'), var_blue());
        renderBarChart('devicesChart', countBy(visitors, v => v.deviceType || 'Desconocido'), var_orange());
        renderBarChart('pagesChart', countBy(pageviews, v => v.page || '/'), var_green());
        renderBarChart('referrersChart', countBy(visitors, v => {
          const r = v.referrer || 'direct';
          try { return r === 'direct' ? 'üîó Directo' : new URL(r).hostname; } catch { return r; }
        }), var_accent2());
        renderVisitorsTable(visitors);
        renderEventsTable(events);
      } catch (err) {
        console.error('Error loading analytics:', err);
      }

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    };

    // --- Render functions ---

    function renderStats(visitors, pageviews, events, uniqueVisitors) {
      const totalVisits = visitors.length;
      const uniqueCount = uniqueVisitors.length;
      const totalPageviews = pageviews.length;
      const totalEvents = events.length;

      // Avg pages per session
      const sessionPages = {};
      pageviews.forEach(pv => {
        sessionPages[pv.sessionId] = (sessionPages[pv.sessionId] || 0) + 1;
      });
      const sessions = Object.keys(sessionPages);
      const avgPages = sessions.length ? (totalPageviews / sessions.length).toFixed(1) : '0';

      // Mobile vs desktop
      const mobileCount = visitors.filter(v => v.deviceType === 'mobile').length;
      const mobilePercent = totalVisits ? Math.round(mobileCount / totalVisits * 100) : 0;

      // Top country
      const countries = countBy(visitors, v => v.geo?.country || 'Desconocido');
      const topCountry = countries.length ? countries[0] : { key: '-', count: 0 };

      // Returning visitors
      const returning = uniqueVisitors.filter(v => v.visitCount > 1).length;

      const html = `
        <div class="stat-card accent">
          <div class="label">Visitas totales</div>
          <div class="value">${totalVisits}</div>
          <div class="sub">En el periodo seleccionado</div>
        </div>
        <div class="stat-card green">
          <div class="label">Visitantes √∫nicos</div>
          <div class="value">${uniqueCount}</div>
          <div class="sub">${returning} recurrentes</div>
        </div>
        <div class="stat-card blue">
          <div class="label">P√°ginas vistas</div>
          <div class="value">${totalPageviews}</div>
          <div class="sub">${avgPages} p√°g/sesi√≥n</div>
        </div>
        <div class="stat-card orange">
          <div class="label">Eventos</div>
          <div class="value">${totalEvents}</div>
          <div class="sub">Interacciones trackeadas</div>
        </div>
        <div class="stat-card">
          <div class="label">M√≥vil</div>
          <div class="value">${mobilePercent}%</div>
          <div class="sub">${mobileCount} de ${totalVisits}</div>
        </div>
        <div class="stat-card">
          <div class="label">Top pa√≠s</div>
          <div class="value" style="font-size:20px;">${topCountry.key}</div>
          <div class="sub">${topCountry.count} visitas</div>
        </div>
      `;
      document.getElementById('statsGrid').innerHTML = html;
    }

    function renderTimeline(visitors) {
      const days = {};
      visitors.forEach(v => {
        const date = v.localTime ? v.localTime.split('T')[0] : null;
        if (date) days[date] = (days[date] || 0) + 1;
      });

      const sortedDays = Object.entries(days).sort((a, b) => a[0].localeCompare(b[0]));
      if (sortedDays.length === 0) {
        document.getElementById('timelineChart').innerHTML = '<p style="color:var(--text2)">Sin datos</p>';
        return;
      }

      const maxVal = Math.max(...sortedDays.map(d => d[1]));

      const barsHtml = sortedDays.map(([date, count]) => {
        const height = Math.max(4, (count / maxVal) * 100);
        const shortDate = date.slice(5);
        return `<div class="timeline-bar" style="height:${height}%;">
          <div class="tooltip">${shortDate}: ${count} visitas</div>
        </div>`;
      }).join('');

      const first = sortedDays[0][0].slice(5);
      const last = sortedDays[sortedDays.length - 1][0].slice(5);

      document.getElementById('timelineChart').innerHTML = `
        <div class="timeline-bars">${barsHtml}</div>
        <div class="timeline-labels"><span>${first}</span><span>${last}</span></div>
      `;
    }

    function renderBarChart(containerId, data, color) {
      const top = data.slice(0, 8);
      if (top.length === 0) {
        document.getElementById(containerId).innerHTML = '<p style="color:var(--text2)">Sin datos</p>';
        return;
      }
      const maxVal = Math.max(...top.map(d => d.count));

      const html = top.map(item => {
        const pct = (item.count / maxVal) * 100;
        return `<div class="bar-row">
          <div class="bar-label" title="${item.key}">${item.key}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width:${pct}%;background:${color};"></div>
          </div>
          <div class="bar-value">${item.count}</div>
        </div>`;
      }).join('');

      document.getElementById(containerId).innerHTML = `<div class="bar-chart">${html}</div>`;
    }

    function renderVisitorsTable(visitors) {
      const rows = visitors.slice(0, 50).map(v => {
        const date = v.localTime ? new Date(v.localTime).toLocaleString('es-ES') : '-';
        const location = v.geo ? `${countryFlag(v.geo.countryCode)} ${v.geo.city}, ${v.geo.country}` : '-';
        const device = v.deviceType || '-';
        const badgeClass = device === 'mobile' ? 'badge-mobile' : device === 'tablet' ? 'badge-tablet' : 'badge-desktop';
        const screen = v.screenWidth ? `${v.screenWidth}√ó${v.screenHeight}` : '-';
        const referrer = v.referrer === 'direct' ? 'Directo' : v.referrer || '-';
        const shortRef = referrer.length > 30 ? referrer.substring(0, 30) + '...' : referrer;

        return `<tr>
          <td>${date}</td>
          <td>${location}</td>
          <td><span class="badge ${badgeClass}">${device}</span></td>
          <td>${v.browser || '-'} ${v.browserVersion ? v.browserVersion.split('.')[0] : ''}</td>
          <td>${screen}</td>
          <td>${v.language || '-'}</td>
          <td title="${referrer}">${shortRef}</td>
        </tr>`;
      }).join('');

      document.getElementById('visitorsTable').innerHTML = rows || '<tr><td colspan="7" style="text-align:center;color:var(--text2)">Sin datos</td></tr>';
    }

    function renderEventsTable(events) {
      const rows = events.slice(0, 30).map(e => {
        const date = e.localTime ? new Date(e.localTime).toLocaleString('es-ES') : '-';
        const data = e.eventData ? JSON.stringify(e.eventData) : '-';
        return `<tr>
          <td>${date}</td>
          <td><strong>${e.eventName || '-'}</strong></td>
          <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;">${data}</td>
        </tr>`;
      }).join('');

      document.getElementById('eventsTable').innerHTML = rows || '<tr><td colspan="3" style="text-align:center;color:var(--text2)">Sin eventos</td></tr>';
    }

    // --- Utilities ---

    function countBy(arr, keyFn) {
      const counts = {};
      arr.forEach(item => {
        const key = keyFn(item);
        counts[key] = (counts[key] || 0) + 1;
      });
      return Object.entries(counts)
        .map(([key, count]) => ({ key, count }))
        .sort((a, b) => b.count - a.count);
    }

    function countryFlag(code) {
      if (!code || code.length !== 2) return 'üåê';
      return String.fromCodePoint(...[...code.toUpperCase()].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
    }

    function var_accent() { return '#6c63ff'; }
    function var_blue() { return '#42a5f5'; }
    function var_orange() { return '#ffa726'; }
    function var_green() { return '#4ecdc4'; }
    function var_accent2() { return '#9c88ff'; }
  </script>
</body>
</html>
